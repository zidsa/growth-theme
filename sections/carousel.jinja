<section
  section-id="{{ sectionId }}"
  class="relative overflow-hidden"
  data-variant="{{ settings.style_variant | default('default') }}"
>
  <!-- Embla root -->
  <div class="embla w-full">
    <div class="embla__container h-full">
      {% for slide in settings.slides %}
        <div class="embla__slide relative flex items-center justify-center overflow-hidden">
          <!-- Background image for this slide -->
          <div
            class="absolute inset-0 -z-10 bg-cover bg-no-repeat"
            style="background-image: url('{{ slide.background_image }}'); background-position: {{ slide.background_position | default('center') }}"
          >
            <div
              class="bg-primary absolute inset-0"
              style="opacity: {{ slide.overlay_opacity | default(5) / 100 }}"
            ></div>
          </div>

          <div
            class="{% if settings.style_variant == 'compact' %}py-6 md:py-32{% else %}py-6 md:py-0{% endif %} w-full px-4 md:px-16"
          >
            <!-- Content for this slide -->
            <div
              class="theme-container space-y-6"
              style="text-align: {{ slide.text_alignment | default('start') }}"
            >
              <div>
                {% if slide.badge_text %}
                  <span class="text-[16px] leading-normal [font-variant:all-small-caps]">{{ slide.badge_text }}</span>
                {% endif %}
                <h2
                  class="text-[40px] leading-[48px] uppercase [font-variant:all-small-caps] md:text-[56px] md:leading-[67.2px]"
                >
                  {{ slide.heading }}
                </h2>
                {% if slide.description %}
                  <p class="text-[20px] leading-[28px] [font-variant:all-small-caps]">{{ slide.description }}</p>
                {% endif %}
              </div>
              {% if slide.button_text %}
                <a
                  href="{{ slide.button_url | default('#') }}"
                  class="bg-primary text-primary-foreground inline-block rounded px-4 py-3"
                >
                  {{ slide.button_text }}
                </a>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- arrows & dots -->
    {% if settings.slides | length > 1 %}
      {% if settings.show_dots %}
        <div
          class="embla__dots pointer-events-auto absolute bottom-8 left-1/2 z-10 flex -translate-x-1/2 gap-2 rounded-full bg-white/10 p-2 backdrop-blur-xs"
        ></div>
      {% endif %}
    {% endif %}
  </div>

  {# prettier-ignore-start #}
    <style>
        [section-id="{{ sectionId }}"] .embla__slide {
            min-height: {{ settings.min_height_mobile | default(700) }}px;
        }

        @media (min-width: 768px) {
            [section-id="{{ sectionId }}"] .embla__slide {
                min-height: {{ settings.min_height_desktop | default(700) }}px;
            }
        }

        {% if settings.transition_effect == 'fade' %}
            /* Fade effect: use grid layout */
            [section-id="{{ sectionId }}"] .embla__container {
                display: grid;
                grid-auto-flow: column;
                grid-auto-columns: 100%;
                height: 100%;
            }
        {% else %}
            /* Slide effect: use flex layout */
            [section-id="{{ sectionId }}"] .embla__container {
                display: flex;
            }
        {% endif %}
    </style>
    {# prettier-ignore-end #}
</section>

<script>
  (function () {
    const root = document.querySelector('[section-id="{{ sectionId }}"]');
    const emblaRoot = root.querySelector(".embla");
    const slideCount = emblaRoot.querySelectorAll(".embla__slide").length;

    // Only initialize Embla if there's more than one slide
    if (slideCount <= 1) return;

    const dotsRoot = emblaRoot.querySelector(".embla__dots");

    // Settings
    const autoplayEnabled = {{ settings.autoplay_enabled | default(true) | tojson }};
    const autoplayDelay = {{ settings.autoplay_delay | default(4000) }};
    const transitionEffect = "{{ settings.transition_effect | default('fade') }}";

    // Build plugins array
    const plugins = [];

    // Add fade plugin if selected
    if (transitionEffect === "fade") {
      plugins.push(EmblaCarouselFade());
    }

    // Add autoplay plugin if enabled
    if (autoplayEnabled) {
      const autoplay = EmblaCarouselAutoplay(
        { delay: autoplayDelay, stopOnMouseEnter: true, stopOnInteraction: false },
        emblaRoot
      );
      plugins.push(autoplay);
    }

    // Initialize Embla
    const embla = EmblaCarousel(
      emblaRoot,
      {
        direction: document.dir === "rtl" ? "rtl" : "ltr",
        loop: true,
        duration: transitionEffect === "fade" ? 25 : 20
      },
      plugins
    );

    // Dots
    const addDots = () => {
      if (!dotsRoot) return;
      dotsRoot.innerHTML = "";
      embla.slideNodes().forEach((_, i) => {
        const b = document.createElement("button");
        b.type = "button";
        b.className =
          "h-2 w-3 rounded-full bg-white/50 data-[active=true]:w-5 data-[active=true]:bg-white/80 transition-all";
        b.addEventListener("click", () => embla.scrollTo(i));
        dotsRoot.appendChild(b);
      });
    };
    const setActiveDot = () => {
      if (!dotsRoot) return;
      const i = embla.selectedScrollSnap();
      dotsRoot.querySelectorAll("button").forEach((b, idx) => (b.dataset.active = String(idx === i)));
    };

    embla.on("init", () => {
      addDots();
      setActiveDot();
    });
    embla.on("select", setActiveDot);
  })();
</script>
