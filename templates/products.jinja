{% extends "layout.jinja" %}

{% block title %}{{ store.name }} â€“ {{ _('All Products') }}{% endblock %}

{% block content %}
  {# Breadcrumb Section #}
  <section class="px-4 py-6 md:px-16">
    <div class="theme-container">
      {%
        with
        items=[
          {'href': url_for('home'), 'label': _("Home")},
          {'label': _("All Products")}
        ]
      %}
        {% include 'components/ui/breadcrumb.jinja' %}
      {% endwith %}
    </div>
  </section>

  <section class="px-4 pb-6 md:px-16 md:pb-16">
    <div class="theme-container">
      {# Products Content - This entire container is swapped during AJAX filtering #}
      <div
        id="products-content"
        class="flex flex-col gap-6 transition-opacity duration-200"
      >
        {% include 'components/products/products-header.jinja' %}
        <div
          data-grid-root="true"
          data-grid="four"
          class="group/grid grid gap-x-4 gap-y-10 data-[grid=four]:grid-cols-1 data-[grid=list]:grid-cols-1 data-[grid=one]:grid-cols-1 data-[grid=two]:grid-cols-1 data-[grid=four]:md:grid-cols-2 data-[grid=two]:md:grid-cols-2 data-[grid=four]:lg:grid-cols-4 data-[grid=two]:lg:grid-cols-2"
        >
          {% for product in products.results %}
            {% include 'components/products/product-card.jinja' %}
          {% endfor %}
        </div>
        {% set totalPages = ((products.count / (session.query_params.get('page_size') or 12)|int) | round(0, 'ceil')) | int %}
        {% set currentPage = products.page %}
        {% include 'components/products/pagination.jinja' %}
      </div>
    </div>
  </section>

  {# Quick View Modal #}
  {% include 'components/products/quick-view-modal.jinja' %}

  <script>
    (function () {
      // Track grid mode separately for desktop and mobile
      let desktopGridMode = "four";
      let mobileGridMode = "one";

      function isMobile() {
        return window.matchMedia("(max-width: 767px)").matches;
      }

      function getCurrentMode() {
        return isMobile() ? mobileGridMode : desktopGridMode;
      }

      function initGridControls() {
        const gridRoot = document.querySelector("[data-grid-root]");
        const desktopButtons = document.querySelectorAll("[data-grid-btn]:not([data-grid-btn='one'])");
        const mobileButtons = document.querySelectorAll("[data-grid-btn='one'], [data-grid-btn='list']");

        if (!gridRoot) return;

        // Apply current mode to grid root
        gridRoot.setAttribute("data-grid", getCurrentMode());

        // Update button checked states
        const allButtons = document.querySelectorAll("[data-grid-btn]");
        allButtons.forEach((btn) => {
          const mode = btn.dataset.gridBtn;
          const isDesktopBtn = mode === "two" || mode === "four";
          const isMobileBtn = mode === "one";
          const isListBtn = mode === "list";

          let shouldCheck = false;
          if (isDesktopBtn) {
            shouldCheck = mode === desktopGridMode;
          } else if (isMobileBtn) {
            shouldCheck = mobileGridMode === "one";
          } else if (isListBtn) {
            // List button appears on both - check based on current context
            shouldCheck = (isMobile() && mobileGridMode === "list") || (!isMobile() && desktopGridMode === "list");
          }

          btn.checked = shouldCheck;
        });
      }

      function setGrid(mode) {
        const gridRoot = document.querySelector("[data-grid-root]");

        // Update the appropriate mode based on button type
        if (mode === "one") {
          mobileGridMode = mode;
        } else if (mode === "two" || mode === "four") {
          desktopGridMode = mode;
        } else if (mode === "list") {
          // List mode updates based on current viewport
          if (isMobile()) {
            mobileGridMode = mode;
          } else {
            desktopGridMode = mode;
          }
        }

        if (gridRoot) {
          gridRoot.setAttribute("data-grid", mode);
        }

        // Update all button states
        initGridControls();
      }

      // Event delegation for grid buttons (works after AJAX swap)
      document.addEventListener("click", (e) => {
        const btn = e.target.closest("[data-grid-btn]");
        if (btn) {
          setGrid(btn.dataset.gridBtn);
        }
      });

      // Handle viewport changes
      const mediaQuery = window.matchMedia("(max-width: 767px)");
      mediaQuery.addEventListener("change", () => {
        const gridRoot = document.querySelector("[data-grid-root]");
        if (gridRoot) {
          gridRoot.setAttribute("data-grid", getCurrentMode());
        }
        initGridControls();
      });

      // Re-initialize after AJAX swap
      window.addEventListener("products-updated", initGridControls);

      // Initial setup
      initGridControls();
    })();
  </script>
{% endblock %}
