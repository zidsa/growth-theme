{#
  Review Filters Component

  Props:
  - product: Product object with rating data
  - selected_ratings: array of selected rating values (e.g., ['5', '4'])
  - selected_type: 'with_media' | 'without_media' | null
  - sort_by: current sort value (e.g., 'most_recent', 'highest_rating', 'lowest_rating')
#}

{% set selected_ratings = selected_ratings or [] %}
{% set selected_type = selected_type or '' %}
{% set sort_by = sort_by or 'most_recent' %}

{# Sort options #}
{%
  set sort_options = [
    { 'value': 'most_recent', 'label': _('Most recent') },
    { 'value': 'highest_rating', 'label': _('Highest rating') },
    { 'value': 'lowest_rating', 'label': _('Lowest rating') }
  ]
%}
{% set current_sort_label = sort_options | selectattr('value', 'equalto', sort_by) | map(attribute='label') | first | default(_('Most recent')) %}

<div class="border-border border-y py-4">
  <div class="flex flex-col gap-2">
    <p class="text-foreground text-tagline">{{ _("Filters & Sorting") }}</p>
    {# Filters & Sorting Header #}
    <div class="flex flex-wrap items-center justify-between gap-4">
      {# Left: Filters #}
      <div class="flex items-center gap-3">
        <span class="text-muted-foreground text-body1">{{ _("Filters") }}</span>

        {# Rating Filter #}
        <button
          popovertarget="review-rating-popover"
          type="button"
          class="text-foreground text-body1 group inline-flex items-center justify-center gap-2 border-none bg-transparent focus:ring-0"
        >
          <span>{{ _("Rating") }}</span>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 16 16"
            fill="none"
            class="transition-transform duration-200 group-aria-expanded:rotate-180"
          >
            <path
              d="M8 5.96875C8.01431 5.96879 8.01997 5.97104 8.02148 5.97168C8.02382 5.97269 8.03271 5.97706 8.04785 5.99219L11.3438 9.28809C11.3597 9.30408 11.3644 9.31349 11.3652 9.31543C11.3656 9.31635 11.3672 9.32094 11.3672 9.33301C11.3671 9.34474 11.3656 9.3487 11.3652 9.34961C11.3645 9.35129 11.3601 9.36063 11.3438 9.37695C11.3289 9.39179 11.3198 9.39549 11.3174 9.39648C11.3148 9.39752 11.3076 9.40039 11.291 9.40039C11.2739 9.40036 11.2668 9.3974 11.2646 9.39648C11.2621 9.39541 11.253 9.39166 11.2383 9.37695L11.2373 9.37598L8.35254 6.50684L7.99902 6.15527L4.76074 9.39355C4.75291 9.40139 4.74699 9.40529 4.74414 9.40723C4.74242 9.40839 4.74153 9.40902 4.74121 9.40918H4.73438C4.71613 9.4085 4.70117 9.40625 4.67188 9.37695C4.65695 9.36203 4.65334 9.35297 4.65234 9.35059C4.65136 9.34822 4.64844 9.34117 4.64844 9.32422C4.64844 9.30715 4.65138 9.30016 4.65234 9.29785C4.65334 9.29547 4.65694 9.28642 4.67188 9.27148L7.95117 5.99219C7.96696 5.9764 7.97663 5.97248 7.97852 5.97168C7.98051 5.97086 7.98651 5.96875 8 5.96875Z"
              fill="currentColor"
              stroke="currentColor"
            ></path>
          </svg>
        </button>
        <el-popover
          id="review-rating-popover"
          anchor="bottom center"
          popover
          class="origin-top-center border-border-light bg-background min-w-[200px] rounded-none border p-4 transition transition-discrete [--anchor-gap:--spacing(2.5)] data-closed:scale-95 data-closed:transform data-closed:opacity-0 data-enter:duration-100 data-enter:ease-out data-leave:duration-75 data-leave:ease-in"
        >
          <div class="space-y-1">
            {% set total_reviews = product.rating.total_count or 0 %}
            {% for i in range(5, 0, -1) %}
              {% set rating_key = 'ratings_' ~ i %}
              {% set rating_data = product.rating[rating_key] if product.rating else none %}
              {% set count = rating_data.count if rating_data else 0 %}
              <label class="form-control py-2">
                <input
                  type="checkbox"
                  id="review-rating-{{ i }}"
                  name="review_rating"
                  value="{{ i }}"
                  {% if i|string in selected_ratings %}checked{% endif %}
                  data-review-filter="rating"
                  data-value="{{ i }}"
                  class="form-checkbox"
                />
                {{ i }} {{ _('star') if i == 1 else _('stars') }} ({{ count }})
              </label>
            {% endfor %}
          </div>
        </el-popover>

        {# Type Filter #}
        <button
          popovertarget="review-type-popover"
          type="button"
          class="text-foreground text-body1 group inline-flex items-center justify-center gap-2 border-none bg-transparent focus:ring-0"
        >
          <span>{{ _("Type") }}</span>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 16 16"
            fill="none"
            class="transition-transform duration-200 group-aria-expanded:rotate-180"
          >
            <path
              d="M8 5.96875C8.01431 5.96879 8.01997 5.97104 8.02148 5.97168C8.02382 5.97269 8.03271 5.97706 8.04785 5.99219L11.3438 9.28809C11.3597 9.30408 11.3644 9.31349 11.3652 9.31543C11.3656 9.31635 11.3672 9.32094 11.3672 9.33301C11.3671 9.34474 11.3656 9.3487 11.3652 9.34961C11.3645 9.35129 11.3601 9.36063 11.3438 9.37695C11.3289 9.39179 11.3198 9.39549 11.3174 9.39648C11.3148 9.39752 11.3076 9.40039 11.291 9.40039C11.2739 9.40036 11.2668 9.3974 11.2646 9.39648C11.2621 9.39541 11.253 9.39166 11.2383 9.37695L11.2373 9.37598L8.35254 6.50684L7.99902 6.15527L4.76074 9.39355C4.75291 9.40139 4.74699 9.40529 4.74414 9.40723C4.74242 9.40839 4.74153 9.40902 4.74121 9.40918H4.73438C4.71613 9.4085 4.70117 9.40625 4.67188 9.37695C4.65695 9.36203 4.65334 9.35297 4.65234 9.35059C4.65136 9.34822 4.64844 9.34117 4.64844 9.32422C4.64844 9.30715 4.65138 9.30016 4.65234 9.29785C4.65334 9.29547 4.65694 9.28642 4.67188 9.27148L7.95117 5.99219C7.96696 5.9764 7.97663 5.97248 7.97852 5.97168C7.98051 5.97086 7.98651 5.96875 8 5.96875Z"
              fill="currentColor"
              stroke="currentColor"
            ></path>
          </svg>
        </button>
        <el-popover
          id="review-type-popover"
          anchor="bottom center"
          popover
          class="origin-top-center border-border-light bg-background min-w-[200px] rounded-none border p-4 transition transition-discrete [--anchor-gap:--spacing(2.5)] data-closed:scale-95 data-closed:transform data-closed:opacity-0 data-enter:duration-100 data-enter:ease-out data-leave:duration-75 data-leave:ease-in"
        >
          <div class="space-y-1">
            <label class="form-control py-2">
              <input
                type="checkbox"
                id="review-type-with-media"
                name="review_type"
                value="with_media"
                {% if selected_type == 'with_media' %}checked{% endif %}
                data-review-filter="type"
                data-value="with_media"
                class="form-checkbox"
              />
              {{ _('With media') }}
            </label>
            <label class="form-control py-2">
              <input
                type="checkbox"
                id="review-type-without-media"
                name="review_type"
                value="without_media"
                {% if selected_type == 'without_media' %}checked{% endif %}
                data-review-filter="type"
                data-value="without_media"
                class="form-checkbox"
              />
              {{ _('Without media') }}
            </label>
          </div>
        </el-popover>
      </div>

      {# Right: Sort #}
      <div class="flex items-center gap-3">
        <span class="text-muted-foreground text-body1">{{ _("Sort by") }}</span>

        <el-select
          id="review-sort-select"
          value="{{ sort_by }}"
          data-review-sort
        >
          <button
            type="button"
            class="text-foreground text-body1 group inline-flex items-center justify-center gap-2 border-none bg-transparent focus:ring-0"
          >
            <el-selectedcontent class="underline underline-offset-auto">{{ current_sort_label }}</el-selectedcontent>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 16 16"
              fill="none"
              class="transition-transform duration-200 group-aria-expanded:rotate-180"
              aria-hidden="true"
            >
              <path
                d="M8 5.96875C8.01431 5.96879 8.01997 5.97104 8.02148 5.97168C8.02382 5.97269 8.03271 5.97706 8.04785 5.99219L11.3438 9.28809C11.3597 9.30408 11.3644 9.31349 11.3652 9.31543C11.3656 9.31635 11.3672 9.32094 11.3672 9.33301C11.3671 9.34474 11.3656 9.3487 11.3652 9.34961C11.3645 9.35129 11.3601 9.36063 11.3438 9.37695C11.3289 9.39179 11.3198 9.39549 11.3174 9.39648C11.3148 9.39752 11.3076 9.40039 11.291 9.40039C11.2739 9.40036 11.2668 9.3974 11.2646 9.39648C11.2621 9.39541 11.253 9.39166 11.2383 9.37695L11.2373 9.37598L8.35254 6.50684L7.99902 6.15527L4.76074 9.39355C4.75291 9.40139 4.74699 9.40529 4.74414 9.40723C4.74242 9.40839 4.74153 9.40902 4.74121 9.40918H4.73438C4.71613 9.4085 4.70117 9.40625 4.67188 9.37695C4.65695 9.36203 4.65334 9.35297 4.65234 9.35059C4.65136 9.34822 4.64844 9.34117 4.64844 9.32422C4.64844 9.30715 4.65138 9.30016 4.65234 9.29785C4.65334 9.29547 4.65694 9.28642 4.67188 9.27148L7.95117 5.99219C7.96696 5.9764 7.97663 5.97248 7.97852 5.97168C7.98051 5.97086 7.98651 5.96875 8 5.96875Z"
                fill="currentColor"
                stroke="currentColor"
              ></path>
            </svg>
          </button>

          <el-options
            popover
            anchor="bottom center"
            class="origin-top-center border-border-light bg-background min-w-[180px] rounded-none border py-2 transition transition-discrete [--anchor-gap:--spacing(2.5)] data-closed:scale-95 data-closed:opacity-0 data-enter:duration-100 data-enter:ease-out data-leave:duration-75 data-leave:ease-in"
          >
            {% for option in sort_options %}
              <el-option
                value="{{ option.value }}"
                class="text-foreground text-body1 hover:bg-secondary aria-selected:bg-secondary block w-full cursor-pointer px-4 py-2 transition-colors"
              >
                {{ option.label }}
              </el-option>
            {% endfor %}
          </el-options>
        </el-select>
      </div>
    </div>

    {# Applied Filters Tags #}
    {% set has_filters = selected_ratings|length > 0 or selected_type %}
    {% if has_filters %}
      <div
        class="flex flex-wrap items-center gap-2"
        data-review-applied-filters
      >
        {# Rating Tags #}
        {% for rating in selected_ratings %}
          <button
            type="button"
            class="badge badge-outlined shrink-0 cursor-pointer whitespace-nowrap transition-opacity hover:opacity-70"
            data-remove-filter="rating"
            data-value="{{ rating }}"
          >
            {{ rating }} {{ _('STARS') }}
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z"
              />
            </svg>
          </button>
        {% endfor %}

        {# Type Tag #}
        {% if selected_type %}
          {% set type_label = _('With media') if selected_type == 'with_media' else _('Without media') %}
          <button
            type="button"
            class="badge badge-outlined shrink-0 cursor-pointer whitespace-nowrap transition-opacity hover:opacity-70"
            data-remove-filter="type"
            data-value="{{ selected_type }}"
          >
            {{ type_label }}
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z"
              />
            </svg>
          </button>
        {% endif %}

        {# Clear All Button #}
        <button
          type="button"
          class="btn btn-text btn-md hover:underline"
          data-clear-all-filters
        >
          {{ _("Clear all") }}
        </button>
      </div>
    {% endif %}
  </div>
</div>
