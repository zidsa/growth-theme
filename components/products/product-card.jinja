{# Image aspect ratio: adapt (natural), square (1/1), portrait (3/4) #}
{% set aspect_ratio = card_image_aspect_ratio | default('adapt') %}
{% set aspect_class = '' if aspect_ratio == 'adapt' else ('aspect-square' if aspect_ratio == 'square' else 'aspect-[3/4]') %}

<div
  class="group relative flex h-full flex-col gap-4 group-data-[grid=list]/grid:grid group-data-[grid=list]/grid:grid-cols-2 group-data-[grid=list]/grid:grid-rows-[1fr_auto] group-data-[grid=list]/grid:gap-4 md:group-data-[grid=list]/grid:grid-cols-[auto_1fr] md:group-data-[grid=list]/grid:grid-rows-[auto_auto]"
  data-product-card="{{ product.id }}"
>
  <a onclick="onProductClick(this)" data-product='{{ product | tojson | safe }}'
     data-list-name="{{ listName }}" data-list-id="{{ listId }}" data-index="{{ index }}"
    href="#"
    class="{{ aspect_class }} relative block w-full overflow-hidden rounded group-data-[grid=list]/grid:col-span-1 group-data-[grid=list]/grid:row-span-1 group-data-[grid=list]/grid:aspect-square md:group-data-[grid=list]/grid:row-span-2 md:group-data-[grid=list]/grid:h-80"
  >
    <img
      {% if product.main_image and product.main_image.image %}
        src="{{ image_url(product.main_image.image.full_size, w=300, q=75, f='auto') }}"
      {% elif product.images and product.images|length > 0 %}
        src="{{ image_url(product.images[0].image.full_size, w=300, q=75, f='auto') }}"
      {% else %}
        src="{{ image_url(('images/product-img.svg' | asset_url), w=300, q=100, f='auto') }}"
      {% endif %}
      alt="{{ product.name }}"
      class="{{ 'h-auto' if aspect_ratio == 'adapt' else 'h-full object-cover' }} w-full object-center"
      {% set img_index = index if index is defined else (loop.index0 if loop is defined else 0) %}
      {% if img_index > 3 %}loading="lazy"{% elif img_index == 0 and is_priority | default(false) %}fetchpriority="high"{% endif %}
    />
    <div class="absolute top-4 flex flex-col gap-2 ltr:left-4 rtl:right-4">
      {# Merchant custom badge #}
      {% if product.badge %}
        {% with product=product %}
          {% include 'components/products/merchant-badge.jinja' %}
        {% endwith %}
      {% endif %}
      {# Sale badge #}
      {% if (product.sale_price and product.sale_price < product.price) or (product.discount_percentage and product.discount_percentage > 0) %}
        <span class="badge badge-filled">{{ _("SALE") }}</span>
      {% endif %}
      {# Out of stock badge #}
      {% if product.in_stock == false or (product.is_infinite == false and product.quantity is not none and product.quantity <= 0) %}
        <span class="badge badge-filled">{{ _("OUT OF STOCK") }}</span>
      {% endif %}
      {# VAT exemption badge #}
      {% if product.is_taxable == false %}
        <span class="badge badge-filled">{{ _("Tax free") }}</span>
      {% endif %}
      {# Bundle offer badge - loaded via client-side JS #}
      <span
        class="bundle-offer-badge hidden"
        data-bundle-offer-product-id="{{ product.id }}"
      ></span>
      {# Keyword badges #}
      {% if product.keywords and product.keywords|length > 0 %}
        {% for keyword in product.keywords[:2] %}
          <span class="badge badge-filled">{{ keyword|upper }}</span>
        {% endfor %}
      {% endif %}
    </div>
    {% with product_id=product.id, class='absolute bottom-4 ltr:right-4 rtl:left-4' %}
      {% include 'components/products/wishlist-button.jinja' %}
    {% endwith %}
  </a>
  <div
    class="flex flex-1 flex-col gap-3 group-data-[grid=list]/grid:col-span-1 group-data-[grid=list]/grid:row-span-1 group-data-[grid=list]/grid:min-w-0 group-data-[grid=list]/grid:self-start"
  >
    <div class="flex flex-col gap-2">
      <h3 class="text-foreground text-sm font-medium">
        <a onclick="onProductClick(this)" data-product='{{ product | tojson | safe }}'
           data-list-name="{{ listName }}" data-list-id="{{ listId }}" data-index="{{ index }}" href="#"> {{ product.name }} </a>
      </h3>
      {% if store.settings.products.reviews_enabled %}
        {% if product.rating %}
          <div class="flex items-center gap-2">
            {% set rating = product.rating.average %}
            {% include 'components/rating-stars.jinja' %}
            {% if product.rating.total_count > 0 %}
              <span class="text-muted text-sm">({{ product.rating.total_count }})</span>
            {% endif %}
          </div>
        {% endif %}
      {% endif %}
    </div>
    {# Price Section #}
    {% if product.formatted_sale_price is not none %}
      {# Product on sale - show sale price, old price crossed out, and discount #}
      <div class="flex flex-col gap-1">
        <p class="text-foreground text-sm font-semibold">
          {% if product.has_options %}{{ _("From") }}{% endif %}
          {{ product.formatted_sale_price }}
        </p>
        <div class="flex flex-wrap items-center gap-2">
          <span class="text-destructive text-sm line-through"> {{ product.formatted_price }} </span>
          {% if product.discount_percentage and product.discount_percentage > 0 %}
            <span
              class="bg-success/20 text-xs uppercase tracking-wide text-success inline-flex items-center rounded px-2 py-1 font-medium"
            >
              {{ _("Discount") }} {{ product.discount_percentage }}%
            </span>
          {% endif %}
        </div>
      </div>
    {% else %}
      {# Regular price - no sale #}
      <p class="text-foreground text-sm">
        {% if product.has_options %}{{ _("From") }}{% endif %}
        {{ product.formatted_price }}
      </p>
    {% endif %}
    {# Description - Only visible in list view #}
    {% if product.short_description or product.description %}
      <p
        class="text-muted text-sm hidden group-data-[grid=list]/grid:line-clamp-1 group-data-[grid=list]/grid:[display:-webkit-box] md:group-data-[grid=list]/grid:line-clamp-3"
      >
        {{ product.short_description|striptags|truncate(200) or product.description|striptags|truncate(200) }}
      </p>
    {% endif %}
  </div>
  {# Cart Actions #}
  <div
    class="mt-auto group-data-[grid=list]/grid:col-span-2 group-data-[grid=list]/grid:row-span-1 group-data-[grid=list]/grid:mt-0 md:group-data-[grid=list]/grid:col-span-1 md:group-data-[grid=list]/grid:col-start-2 md:group-data-[grid=list]/grid:self-start"
  >
    {% set is_out_of_stock = product.in_stock == false or (product.is_infinite == false and product.quantity is not none and product.quantity <= 0) %}

    {% if is_out_of_stock %}
      {# Notify Me Button - shown when out of stock #}
      <button
        class="btn btn-outlined btn-lg w-full md:group-data-[grid=list]/grid:w-1/2"
        data-notify-me-trigger="{{ product.id }}"
      >
        {{ _("Notify me when available") }}
      </button>
    {% else %}
      {# Add to Cart / Quick View Button #}
      {% set has_options = product.has_options or product.has_fields %}
      <button
        class="btn btn-outlined btn-lg w-full md:group-data-[grid=list]/grid:w-1/2"
        {% if has_options %}
          data-open-quick-view="true" data-product-id="{{ product.id }}"
        {% else %}
          data-add-to-cart="{{ product.id }}"
        {% endif %}
      >
        {{ _("Select options") if has_options else _("Add to cart") }}
      </button>

      {# Quantity Input (hidden, shown after adding to cart) #}
      <div
        class="w-full md:group-data-[grid=list]/grid:w-1/2"
        data-quantity-section
        hidden
      >
        {% with id='card-qty-' ~ product.id, product_id=product.id, quantity=1, show_delete=true, full_width=true %}
          {% include 'components/ui/quantity-input.jinja' %}
        {% endwith %}
      </div>
    {% endif %}
  </div>
</div>
