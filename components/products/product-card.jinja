<div
  class="group relative flex h-full flex-col gap-4 group-data-[grid=list]/grid:grid group-data-[grid=list]/grid:grid-cols-2 group-data-[grid=list]/grid:grid-rows-[1fr_auto] group-data-[grid=list]/grid:gap-4 md:group-data-[grid=list]/grid:grid-cols-[auto_1fr] md:group-data-[grid=list]/grid:grid-rows-[auto_auto]"
  data-product-card="{{ product.id }}"
>
  <a
    href="{{ url_for('product_details', slug=product.slug) }}"
    class="relative block aspect-[3/4] w-full overflow-hidden rounded group-data-[grid=list]/grid:col-span-1 group-data-[grid=list]/grid:row-span-1 group-data-[grid=list]/grid:aspect-square md:group-data-[grid=list]/grid:row-span-2 md:group-data-[grid=list]/grid:h-80"
  >
    <img
      {% if product.main_image and product.main_image.image %}
        src="{{ product.main_image.image.small }}"
      {% elif product.images and product.images|length > 0 %}
        src="{{ product.images[0].image.small }}"
      {% else %}
        src="{{ image_url(('images/product-img.svg' | asset_url), w=235, q=100, f='auto') }}"
      {% endif %}
      alt="{{ product.name }}"
      class="h-full w-full object-cover object-center"
      {% set img_index = index if index is defined else (loop.index0 if loop is defined else 0) %}
      {% if img_index > 3 %}loading="lazy"{% endif %}
    />
    <div class="absolute top-4 flex flex-col gap-2 ltr:left-4 rtl:right-4">
      {# Merchant custom badge #}
      {% if product.badge %}
        {% with product=product %}
          {% include 'components/products/merchant-badge.jinja' %}
        {% endwith %}
      {% endif %}
      {# Sale badge #}
      {% if (product.sale_price and product.sale_price < product.price) or (product.discount_percentage and product.discount_percentage > 0) %}
        {% with content=_("SALE"), variant='filled' %}
          {% include 'components/ui/badge.jinja' %}
        {% endwith %}
      {% endif %}
      {# Out of stock badge #}
      {% if product.in_stock == false or (product.is_infinite == false and product.quantity is not none and product.quantity <= 0) %}
        {% with content=_("OUT OF STOCK"), variant='filled' %}
          {% include 'components/ui/badge.jinja' %}
        {% endwith %}
      {% endif %}
      {# Keyword badges #}
      {% if product.keywords and product.keywords|length > 0 %}
        {% for keyword in product.keywords[:2] %}
          {% with content=keyword|upper, variant='filled' %}
            {% include 'components/ui/badge.jinja' %}
          {% endwith %}
        {% endfor %}
      {% endif %}
    </div>
    {% with product_id=product.id, class='absolute bottom-4 ltr:right-4 rtl:left-4' %}
      {% include 'components/products/wishlist-button.jinja' %}
    {% endwith %}
  </a>
  <div
    class="flex flex-1 flex-col gap-3 group-data-[grid=list]/grid:col-span-1 group-data-[grid=list]/grid:row-span-1 group-data-[grid=list]/grid:min-w-0 group-data-[grid=list]/grid:self-start"
  >
    <div class="flex flex-col gap-2">
      <h3 class="text-[20px] leading-[28px] [font-variant:all-small-caps]">
        <a href="{{ url_for('product_details', slug=product.slug) }}"> {{ product.name }} </a>
      </h3>
      {% if store.settings.products.reviews_enabled %}
        {% if product.rating %}
          <div class="flex items-center gap-2">
            {% set rating = product.rating.average %}
            {% include 'components/rating-stars.jinja' %}
            {% if product.rating.total_count > 0 %}
              <span class="text-secondary text-[14px] leading-[1.5]">({{ product.rating.total_count }})</span>
            {% endif %}
          </div>
        {% endif %}
      {% endif %}
    </div>
    {# Price Section #}
    {% if product.formatted_sale_price is not none %}
      {# Product on sale - show sale price, old price crossed out, and discount #}
      <div class="flex flex-col gap-1">
        <p class="text-primary text-[16px] leading-[24px] font-semibold">
          {% if product.has_options %}{{ _("From") }}{% endif %}
          {{ product.formatted_sale_price }}
        </p>
        <div class="flex flex-wrap items-center gap-2">
          <span class="text-secondary text-[14px] leading-[21px] line-through"> {{ product.formatted_price }} </span>
          {% if product.discount_percentage and product.discount_percentage > 0 %}
            <span
              class="inline-flex items-center rounded-md bg-[#DDF8DC] px-2 py-1 text-[12px] leading-normal font-medium text-[#649560] [font-variant:all-small-caps]"
            >
              {{ _("Discount") }} {{ product.discount_percentage }}%
            </span>
          {% endif %}
        </div>
      </div>
    {% else %}
      {# Regular price - no sale #}
      <p class="text-primary text-[16px] leading-[24px]">
        {% if product.has_options %}{{ _("From") }}{% endif %}
        {{ product.formatted_price }}
      </p>
    {% endif %}
    {# Description - Only visible in list view #}
    {% if product.short_description or product.description %}
      <p
        class="text-secondary hidden text-[14px] leading-[21px] group-data-[grid=list]/grid:line-clamp-1 group-data-[grid=list]/grid:[display:-webkit-box] md:group-data-[grid=list]/grid:line-clamp-3"
      >
        {{ product.short_description|striptags|truncate(200) or product.description|striptags|truncate(200) }}
      </p>
    {% endif %}
  </div>
  <div
    class="cart-action-wrapper mt-auto group-data-[grid=list]/grid:col-span-2 group-data-[grid=list]/grid:row-span-1 group-data-[grid=list]/grid:mt-0 md:group-data-[grid=list]/grid:col-span-1 md:group-data-[grid=list]/grid:col-start-2 md:group-data-[grid=list]/grid:self-start"
    data-cart-action
    data-product-id="{{ product.id }}"
  >
    {# Quantity Input (hidden by default, shown when product is in cart) #}
    <div
      class="quantity-section"
      data-quantity-section
      hidden
    >
      <div
        class="text-primary bg-background outline-primary inline-flex items-center justify-between gap-2 rounded px-4 py-3 outline outline-1 transition-all hover:outline-2 active:bg-[#F6F5F4] active:outline-2"
        data-class=" hover:outline-2 active:outline-2 active:bg-[#F6F5F4] px-4 py-3 text-[16px] leading-[24px] w-full md:group-data-[grid=list]/grid:w-1/2"
        data-quantity-input
        data-product-id="{{ product.id }}"
        data-quantity="1"
      >
        {# Delete button (shown when quantity is 1) #}
        {% set delete_icon %}
          <svg
            class="size-4"
            viewBox="0 0 16 16"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M11.3333 6V12.6667H4.66667V6H11.3333ZM10.1667 2H5.83333L5 2.83333H2V4.5H14V2.83333H11L10.1667 2ZM13 4.33333H3V12.6667C3 13.5833 3.75 14.3333 4.66667 14.3333H11.3333C12.25 14.3333 13 13.5833 13 12.6667V4.33333Z"
              fill="currentColor"
            ></path>
          </svg>
        {% endset %}
        {% with content=delete_icon, variant='outlined', size='icon-sm', aria_label=_('Remove') ~ ' ' ~ product.name, attrs='data-quantity-action="remove"' %}
          {% include 'components/ui/button.jinja' %}
        {% endwith %}

        {# Minus button (hidden by default, shown when quantity > 1) #}
        {% set minus_icon %}
          <svg
            class="size-4"
            viewBox="0 0 16 16"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M4 7.44444V8.55556H12V7.44444H4Z"
              fill="currentColor"
            ></path>
          </svg>
        {% endset %}
        {% with content=minus_icon, variant='outlined', size='icon-sm', aria_label=_('Decrease quantity'), attrs='data-quantity-action="decrease" hidden' %}
          {% include 'components/ui/button.jinja' %}
        {% endwith %}

        {# Quantity display #}
        <span
          class="text-primary min-w-[3rem] flex-1 text-center text-sm font-medium"
          data-quantity-display
          >1</span
        >

        {# Plus button #}
        {% set plus_icon %}
          <svg
            class="size-4"
            viewBox="0 0 16 16"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M12.6667 8.66667H8.66667V12.6667H7.33333V8.66667H3.33333V7.33333H7.33333V3.33333H8.66667V7.33333H12.6667V8.66667Z"
              fill="currentColor"
            ></path>
          </svg>
        {% endset %}
        {% with content=plus_icon, variant='outlined', size='icon-sm', aria_label=_('Increase quantity'), attrs='data-quantity-action="increase"' %}
          {% include 'components/ui/button.jinja' %}
        {% endwith %}
      </div>
    </div>

    {# Add to Cart Button (visible by default) #}
    <div
      class="button-section"
      data-button-section
    >
      {%
        with
        content=_("Select options") if (product.has_options or product.has_fields) else _("Add to cart"),
        variant='outlined',
        size='lg',
        class='w-full md:group-data-[grid=list]/grid:w-1/2',
        type='button',
        attrs='data-add-to-cart-btn data-product-id="' + product.id + '" data-product-slug="' + product.slug + '"' + (' data-has-options="true" data-open-quick-view="true"' if (product.has_options or product.has_fields) else '')
      %}
        {% include 'components/ui/button.jinja' %}
      {% endwith %}
    </div>
  </div>
</div>
