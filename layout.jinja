{# Global Product Card Settings #}
{% set card_columns_desktop = settings.product_card_columns_desktop | default('4') %}
{% set card_columns_mobile = settings.product_card_columns_mobile | default('1') %}
{% set card_image_aspect_ratio = settings.product_card_image_aspect_ratio | default('adapt') %}

<!DOCTYPE html>
<html
  class="no-js"
  lang="{{ session.lang }}"
  dir="{{ session.locale.language.direction }}"
>
  <head>
    <meta charset="utf-8" />
    <meta
      http-equiv="x-ua-compatible"
      content="ie=edge"
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    {% vitrin_head %}
    <link
      rel="preconnect"
      href="https://fonts.googleapis.com"
    />
    <link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin
    />

    <link
      rel="stylesheet"
      media="print"
      onload="this.onload=null;this.media='all'"
      href="https://fonts.googleapis.com/css2?family={{ settings.font_family | default('Roboto') }}:wght@300;400;500;700&display=swap"
    />
    {#
      Prettier ignore is needed here because the CSS contains Jinja template variables
      which cause Prettier's PostCSS parser to fail with "Cannot read properties of undefined (reading 'raw')"
    #}
    <!-- prettier-ignore-start -->
    <style>
      :root {
        /* Font */
        --font-family: {{ (settings.font_family | default('Roboto')).replace('+', ' ') }}, sans-serif;

        /* ========== LIGHT MODE COLORS (Default) ========== */
        --background: {{ settings.theme_background | default('#FFFFFF') }};
        --foreground: {{ settings.theme_foreground | default('#0B0A09') }};
        --primary: {{ settings.theme_primary | default('#0B0A09') }};
        --primary-foreground: {{ settings.theme_primary_foreground | default('#FFFFFF') }};
        --secondary: {{ settings.theme_secondary | default('#F6F5F4') }};
        --muted: {{ settings.theme_muted | default('#545352') }};
        --accent: {{ settings.theme_accent | default('#A89C90') }};
        --border: {{ settings.theme_border | default('#B5B5B5') }};
        --input: {{ settings.theme_input | default('#545352') }};
        --ring: {{ settings.theme_ring | default('#0B0A09') }};

        /* ========== RADIUS ========== */
        --radius: {{ settings.theme_radius | default(4) }}px;
      }
    </style>
    <!-- prettier-ignore-end -->

    <link
      rel="stylesheet"
      type="text/css"
      href="{{ 'styles.css' | asset_url }}"
    />

    {# TailwindPlus Elements - pinned version for better caching #}
    <script
      src="https://cdn.jsdelivr.net/npm/@tailwindplus/elements@1.0.22"
      type="module"
    ></script>

    {% if user_custom_css %}
      <link
        rel="stylesheet"
        href="{{ user_custom_css }}"
      />
    {% endif %}
  </head>
  <body
    data-template="{{ session.template }}"
    class="min-h-dvh font-sans antialiased"
  >
    {% include 'header.jinja' %}
    <main id="main">{% block content %}{% endblock %}</main>

    {% include 'footer.jinja' %}
    {% include "vitrin:shared/region_settings_dialog.jinja" %}
    {# Global Notify Me Dialog - for product cards on any page #}
    {% include 'components/products/notify-me-dialog.jinja' %}
    {# Global Quick View Modal - for product cards on any page #}
    {% include 'components/products/quick-view-modal.jinja' %}
    <script>
      window.zidOpenRegionSettingDialog = () => {
        region_settings_dialog?.open();
      };
    </script>
    {# Global config scripts (must run before theme bundle) #}
    <!-- prettier-ignore-start -->
    <script>
      // Layout config for header functionality
      window.layoutConfig = {
        profileUrl: "{{ url_for('profile') }}"
      };

      // Product translations (used by variants.js for variant changes)
      window.productTranslations = {
        discount: "{{ _('Discount') }}",
        remaining: "{{ _('Remaining %s only') }}",
        sold: "{{ _('Sold more than %s times') }}"
      };
      window.storeLowStockEnabled = {{ 'true' if store.settings.products.low_stock_enabled else 'false' }};
      window.storeLowStockThreshold = {{ store.settings.products.low_stock_threshold | default(5) }};

      // Notify Me translations (used by notify-me.js for stock alerts)
      window.notifyMeTranslations = {
        success: "{{ _('You will be notified when this product is back in stock!') }}",
        error: "{{ _('Failed to submit. Please try again.') }}",
        required: "{{ _('Please fill in all required fields') }}",
        phoneRequired: "{{ _('Phone number is required') }}",
        phoneTooShort: "{{ _('Phone number is too short') }}",
        phoneTooLong: "{{ _('Phone number is too long') }}",
        phoneInvalid: "{{ _('Invalid phone number') }}"
      };

      // Custom styles for Vitrin Kit Components (bundle, gift, region dialogs)
      // These override the default styles in platform widgets
      window.zidCustomStyles = {
        bundle_selection: {
          fontFamily: "var(--font-family)",
          fontSize: "14px"
        },
        gift_dialog: {
          fontFamily: "var(--font-family)",
          fontSize: "14px",
          primaryColor: "var(--primary)",
          primaryForeground: "var(--primary-foreground)",
          backgroundColor: "var(--background)",
          borderRadius: "var(--radius)"
        },
        region_settings_dialog: {
          fontFamily: "var(--font-family)",
          fontSize: "14px",
          primaryColor: "var(--primary)",
          primaryForeground: "var(--primary-foreground)",
          backgroundColor: "var(--background)",
          borderRadius: "var(--radius)"
        }
      };
    </script>
    <!-- prettier-ignore-end -->

    {# Bundled theme JS (Vite output) - includes all feature modules #}
    <script
      defer
      src="{{ 'dist/theme.js' | asset_url }}"
    ></script>

    {% vitrin_body %}

    {# Loyalty Rewards - loaded AFTER vitrin_body so popup is in DOM #}
    {% if session.template not in ['product_details', 'cart_page', 'page_details'] and store.settings.checkout.is_loyalty_enabled %}
      <script>
        var loyalty_button_direction = "{{ session.locale.language.direction }}";
        var text_loyalty_rewards = '{{ _("Rewards") }}';
        var text_loyalty_options = '{{ _("For {points} get a discount {percentage}") }}';
        var store_currency_code = "{{ session.currency }}";
      </script>
      <script src="{{ 'js/layout-loyalty.js' | asset_url }}"></script>
    {% endif %}
    {% block footer_scripts %}
    {% endblock %}
  </body>
</html>
